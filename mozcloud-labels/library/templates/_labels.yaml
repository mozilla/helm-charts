{{- define "mozcloud-labels-lib.labels" -}}
{{- /*
We do not need the full context here, so we will only look for select labels:

app_code
artifact_id  # removed due to sync issues where every commit to webservices-infra triggered syncs
component_code
env_code

*/ -}}
{{- $context_labels := list "app_code" "artifact_id" "component_code" "env_code" "mozcloud_chart" "mozcloud_chart_version" -}}
{{- $context := dict -}}
{{- range $context_label := $context_labels -}}
  {{- if index $ $context_label -}}
    {{- $_ := set $context $context_label (index $ $context_label) -}}
  {{- end -}}
{{- end -}}
{{- $chart := "" }}
{{- if .chart }}
  {{- $chart = .chart }}
{{- else if (.Chart).Name }}
  {{- $chart = .Chart.Name }}
{{- else if (.Chart).name }}
  {{- $chart = .Chart.name }}
{{- end }}
{{- if $chart }}
  {{- $_ := set $context "chart" $chart -}}
{{- end }}
{{- $additional_labels := include "mozcloud-labels-lib.additional_labels" $context | fromYaml -}}
{{- $kubernetes_labels := include "mozcloud-labels-lib.kubernetes_labels" $context | fromYaml -}}
{{- $merged_labels := mergeOverwrite $kubernetes_labels $additional_labels -}}
{{ $merged_labels | toYaml }}
{{- end -}}

{{- define "mozcloud-labels-lib.additional_labels" -}}
app_code: {{ .app_code }}
component_code: {{ .component_code }}
env_code: {{ .env_code }}
mozcloud_chart: {{ .mozcloud_chart }}
mozcloud_chart_version: {{ .mozcloud_chart_version }}
{{- if eq .env_code "prod" }}
realm: prod
{{- else }}
realm: nonprod
{{- end }}
{{- end -}}

{{- define "mozcloud-labels-lib.kubernetes_labels" -}}
app.kubernetes.io/name: {{ .app_code }}
app.kubernetes.io/component: {{ .component_code }}
app.kubernetes.io/managed-by: argocd
{{- if .appVersion }}
app.kubernetes.io/version: {{ .appVersion | quote }}
{{- end }}
{{- if .chart }}
helm.sh/chart: {{ .chart }}
{{- end }}
{{- end -}}
