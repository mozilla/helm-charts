{{- define "mozcloud-labels-lib.labels" -}}
{{- /* We do not need the full context here */ -}}
{{- $context := dict "app_code" .app_code "component_code" .component_code "env_code" .env_code  -}}
{{- $chart := "" }}
{{- if .chart }}
  {{- $chart = .chart }}
{{- else if (.Chart).Name }}
  {{- $chart = .Chart.Name }}
{{- else if (.Chart).name }}
  {{- $chart = .Chart.name }}
{{- end }}
{{- if $chart }}
  {{- $_ := set $context "chart" $chart -}}
{{- end }}
{{- $additional_labels := include "mozcloud-labels-lib.additional_labels" $context | fromYaml -}}
{{- /*
Change "precedence" to "shared" once we are ready to go live with the data in
mozcloud-shared-data.
*/}}
{{- $params := dict "context" $context "appCode" .app_code "dataKey" "labels" "customData" $additional_labels "precedence" "local" -}}
{{- $shared_data := include "mozcloud-shared-data-lib.smartMergeData" $params | fromYaml -}}
{{- $kubernetes_labels := include "mozcloud-labels-lib.kubernetes_labels" (mergeOverwrite $context $shared_data) | fromYaml -}}
{{- $merged_labels := mergeOverwrite $shared_data $kubernetes_labels -}}
{{ $merged_labels | toYaml }}
{{- end -}}

{{- define "mozcloud-labels-lib.additional_labels" -}}
{{- if .chart }}
helm.sh/chart: {{ .chart }}
{{- end }}
component_code: {{ .component_code }}
env_code: {{ .env_code }}
{{- if eq .env_code "prod" }}
realm: prod
{{- else }}
realm: nonprod
{{- end }}
{{- if .appVersion }}
app.kubernetes.io/version: {{ .appVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: Helm
{{- end -}}

{{- define "mozcloud-labels-lib.kubernetes_labels" -}}
app.kubernetes.io/name: {{ default .app_code .system }}
app.kubernetes.io/component: {{ .component_code }}
{{- end -}}
