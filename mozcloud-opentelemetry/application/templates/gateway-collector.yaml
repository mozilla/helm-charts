apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: {{ include "mozcloud-opentelemetry.name" . }}-gateway
  namespace: {{ .Release.Namespace }}
spec:
  {{- if .Values.serviceAccount.create }}
  serviceAccount: {{ .Values.serviceAccount.name }}
  {{- end }}
  mode: deployment
  terminationGracePeriodSeconds: 600
  hostNetwork: false
  {{- with .Values.collectors.gateway.securityContext }}
  securityContext: {{ toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.collectors.gateway.autoscaler }}
  autoscaler: {{ toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.collectors.gateway.resources }}
  resources: {{ toYaml . | nindent 4 }}
  {{- end }}
  env:
  - name: POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: POD_IP
    valueFrom:
      fieldRef:
        fieldPath: status.podIP

  ports:
  - name: otlp-collecotrs
    port: {{ .Values.collectors.gateway.endpoints.otlp.collectorMetricsPort }}
    targetPort: {{ .Values.collectors.gateway.endpoints.otlp.collectorMetricsPort }}

  config:
    receivers:
      otlp:
        protocols:
          grpc: {}
          http: {}

      otlp/collectors:
        protocols:
          http:
            endpoint: "0.0.0.0:{{ .Values.collectors.gateway.endpoints.otlp.collectorMetricsPort }}"

      statsd:
        endpoint: ${env:POD_IP}:8125
        aggregation_interval: 30s
        enable_metric_type: true
        enable_simple_tags: true
        is_monotonic_counter: true

    processors:
      # Attach certain label attributes to datapoints, reducing the need for group_left promql functions
      transform/mozcloud:
        error_mode: ignore
        metric_statements:
          - context: datapoint
            statements:
              {{- $mozcloud_annotation_params := .Values.global.mozcloud }}
              {{- $fields := include "mozcloud-labels-lib.annotations.otel.fields" $mozcloud_annotation_params | fromYaml }}
              {{- range $name, $_ := $fields }}
              - set(attributes[{{ $name | quote }}], resource.attributes[{{ $name | quote }}]) where resource.attributes[{{ $name | quote }}] != nil
              {{- end }}

      resource/gcp_project_id:
        attributes:
        - key: gcp.project_id
          value: {{ $.Values.project_id }}
          action: insert

      memory_limiter:
        check_interval: 1s
        limit_percentage: 65
        spike_limit_percentage: 20

      tail_sampling:
        policies:
          - name: error_traces
            type: status_code
            status_code:
              status_codes: [ERROR]
          - name: default_probabilistic
            type: probabilistic
            probabilistic:
              sampling_percentage: 1.0

      resourcedetection:
        detectors: [env, gcp]
        timeout: 10s
        override: false

    exporters:
      debug:
        verbosity: detailed


      otlphttp:
        encoding: json
        endpoint: https://telemetry.googleapis.com
        auth:
          authenticator: googleclientauth
        sending_queue:
          batch:
            sizer: items
            min_size: 200
            max_size: 200
            flush_timeout: 5s

    extensions:
      health_check:
        endpoint: ${env:POD_IP}:13133
      googleclientauth: {}

    service:
      extensions:
      - health_check
      - googleclientauth
      pipelines:
        metrics:
          receivers:
          - otlp
          - statsd
          processors:
          - memory_limiter
          - transform/mozcloud
          - resource/gcp_project_id
          exporters:
          - otlphttp
        metrics/collectors:
          receivers:
          - otlp/collectors
          processors:
          - memory_limiter
          - resourcedetection
          - resource/gcp_project_id
          exporters:
          - otlphttp
        traces:
          receivers:
          - otlp
          processors:
          - memory_limiter
          - resource/gcp_project_id
          - tail_sampling
          exporters:
          - otlphttp
      telemetry:
        logs:
          encoding: json
        resource:
          k8s.deployment.name: {{ include "mozcloud-opentelemetry.name" . }}-gateway-collector
          k8s.pod.name: ${POD_NAME}
          namespace: ${POD_NAMESPACE}
        metrics:
          readers:
            - periodic:
                exporter:
                  otlp:
                    protocol: http/protobuf
                    endpoint: http://${env:POD_IP}:14318
