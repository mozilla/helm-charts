{{- if include "mozcloud.preview.usePreviewHttpRoute" . }}
{{- $chart_metadata := dict "Chart" .Chart "Release" .Release }}
{{- $label_params := mergeOverwrite $chart_metadata (include "mozcloud.labelParams" . | fromYaml) }}
{{- $preview_config := mergeOverwrite (default dict .Values.global.preview) (default dict .Values.preview) }}
{{- $formatter_params := dict "component" "gateway" "workloads" (.Values.workloads | deepCopy) "preview" $preview_config }}
{{- $workloads := include "mozcloud.formatter.workloads" $formatter_params | fromYaml -}}
{{- $helper_params := mergeOverwrite (. | deepCopy) (dict "workloads" $workloads) }}
{{- $params := $label_params -}}

{{- $http_routes := include "mozcloud.config.httpRoutes" $helper_params | fromYaml }}
{{- /* Transform all HTTP routes for preview mode */ -}}
{{- $transform_params := dict "httpRoutes" $http_routes.httpRoutes "previewHost" $.Values.global.preview.host }}
{{- $transformed_http_routes := include "preview.transformHttpRoutes" $transform_params | fromYaml }}
{{- range $http_route_name, $http_route_config := $transformed_http_routes.httpRoutes }}
  {{- $_ := set $label_params "component_code" $http_route_config.component }}

  {{- /* Prefix HTTPRoute name with PR number */ -}}
  {{- $preview_prefix := include "mozcloud.preview.prefix" $ }}
  {{- $prefixed_http_route_name := printf "%s%s" $preview_prefix $http_route_name }}

  {{- /* Override gateway refs to use shared preview gateway */ -}}
  {{- $gateway_name := default "sandbox-high-preview-gateway" (($.Values.preview.httpRoute).gateway).name }}
  {{- $gateway_namespace := default "preview-shared-infrastructure" (($.Values.preview.httpRoute).gateway).namespace }}
  {{- $preview_gateway_refs := list }}
  {{- range $http_route_config.gatewayRefs }}
    {{- $updated_ref := mergeOverwrite . (dict "name" $gateway_name "namespace" $gateway_namespace) }}
    {{- $preview_gateway_refs = append $preview_gateway_refs $updated_ref }}
  {{- end }}

  {{- $_ := set $http_route_config "gatewayRefs" $preview_gateway_refs }}

  {{- $_ = set $params "httpRouteConfig" (dict "httpRoutes" (dict $prefixed_http_route_name (omit $http_route_config "component"))) }}
{{ include "mozcloud-gateway-lib.httpRoute" (mergeOverwrite $params $label_params) -}}
{{- end }}
{{- end -}}
