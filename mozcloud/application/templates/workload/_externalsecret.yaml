{{- define "workload.externalSecret" -}}
{{- $external_secrets := default (dict) .externalSecrets }}
{{- $name_override := default "" .nameOverride }}
{{- $params := list }}
{{- range $name, $config := $external_secrets }}
  {{- if $name_override }}
    {{- $name = $name_override }}
  {{- end }}
  {{- $_ := set $config "name" $name }}
  {{- /* Configure Argo CD annotations */}}
  {{- $annotation_params := dict "config" $config "type" "externalSecret" }}
  {{- $annotations := include "workload.config.argo.annotations" $annotation_params | fromYaml }}
  {{- $_ = set $config "annotations" $annotations }}
  {{- $params = append $params $config }}
  {{- /* Set target to external secret name if not defined */}}
  {{- if not $config.target }}
    {{- $_ = set $config "target" $name }}
  {{- end }}
{{- end }}
{{- $params := mergeOverwrite (. | deepCopy) (dict "externalSecrets" $params) }}
{{- include "common.externalSecret" $params }}
{{- end -}}
