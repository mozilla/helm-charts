{{- if .Values.enabled }}
{{- $chart_metadata := dict "Chart" .Chart "Release" .Release }}
{{- $label_params := mergeOverwrite $chart_metadata (include "mozcloud.labelParams" . | fromYaml) }}
{{- /* Call a helper function that merges user data with defaults */}}
{{- $formatter_params := dict "component" "containers" "workloads" (.Values.workloads | deepCopy) }}
{{- $workloads := include "mozcloud.formatter.workloads" $formatter_params | fromYaml -}}

{{- /* We will build $params as we go */}}
{{- $helper_params := mergeOverwrite (. | deepCopy) (dict "workloads" $workloads) }}
{{- $params := $label_params -}}

{{- /*
Pre-deployment jobs
*/}}
{{- $job_type := dict "jobType" "preDeployment" }}
{{- $jobs := include "mozcloud.config.jobs" (mergeOverwrite $helper_params $job_type) | fromYaml }}
{{- range $job_name, $job_config := $jobs.jobs }}
{{- $_ := set $label_params "component_code" $job_config.component }}
{{- $_ = set $params "jobConfig" (dict "jobs" (dict $job_name (omit $job_config "component"))) }}
{{ include "mozcloud-job-lib.job" (mergeOverwrite $params $label_params) }}
{{- end }}

{{- /*
Post-deployment jobs
*/}}
{{- $job_type := dict "jobType" "postDeployment" }}
{{- $jobs := include "mozcloud.config.jobs" (mergeOverwrite $helper_params $job_type) | fromYaml }}
{{- range $job_name, $job_config := $jobs.jobs }}
{{- $_ := set $label_params "component_code" $job_config.component }}
{{- $_ = set $params "jobConfig" (dict "jobs" (dict $job_name (omit $job_config "component"))) }}
{{ include "mozcloud-job-lib.job" (mergeOverwrite $params $label_params) }}
{{- end }}
{{- end }}
