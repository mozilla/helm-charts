{{- if .Values.enabled }}
{{- $chart_metadata := dict "Chart" .Chart "Release" .Release "component_code" "externalsecret" }}
{{- $label_params := mergeOverwrite $chart_metadata (include "mozcloud.labelParams" . | fromYaml) }}
{{- /* Call a helper function that merges user data with defaults */}}
{{- $preview_config := mergeOverwrite (default dict .Values.global.preview) (default dict .Values.preview) }}
{{- $formatter_params := dict "component" "containers" "workloads" (.Values.workloads | deepCopy) "preview" $preview_config }}
{{- $workloads := include "mozcloud.formatter.workloads" $formatter_params | fromYaml -}}

{{- /* We will build $params as we go */}}
{{- $helper_params := mergeOverwrite (. | deepCopy) (dict "workloads" $workloads) }}
{{- $params := $label_params -}}

{{- /*
External Secrets
*/}}
{{- $external_secrets := include "mozcloud.config.externalSecrets" $helper_params | fromYaml }}
{{- range $external_secret_name, $external_secret_config := $external_secrets.externalSecrets }}
{{- $_ := set $params "externalSecrets" (dict $external_secret_name $external_secret_config) }}
{{- $context_params := mergeOverwrite ($ | deepCopy) (mergeOverwrite $params $label_params) }}
{{ include "workload.externalSecret" $context_params }}
{{- end }}

{{- end }}
