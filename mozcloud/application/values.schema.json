{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "mozcloud-workload",
  "description": "mozcloud-workload values",
  "type": "object",
  "properties": {
    "global": {
      "description": "Global values dictionary",
      "type": "object",
      "properties": {
        "mozcloud": {
          "type": "object",
          "properties": {
            "app_code": {
              "description": "Tenant's application code (eg. sumo, ads, remote-settings). This is automatically populated by Argo CD.",
              "type": "string"
            },
            "artifact_id": {
              "description": "The 8 character short revision of the Helm chart deployed by Argo CD. This is automatically populated by Argo CD.",
              "type": "string"
            },
            "chart": {
              "description": "The name of the chart. This will match the app_code in single chart applications. This is automatically populated by Argo CD.",
              "type": "string"
            },
            "env_code": {
              "description": "Environment (ie. dev, stage, prod). This is automatically populated by Argo CD.",
              "type": "string"
            },
            "image": {
              "description": "The container image repository and tag. This can be managed by Argo Image Updater.",
              "type": "object",
              "properties": {
                "repository": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                }
              }
            },
            "project_id": {
              "description": "GCP project ID. This is automatically populated by Argo CD.",
              "type": "string"
            },
            "realm": {
              "description": "A high-level grouping of infrastructure environments that share common networking and management boundaries (ie. nonprod, prod). This is automatically populated by Argo CD.",
              "type": "string"
            }
          },
          "required": [
            "app_code",
            "chart",
            "env_code",
            "project_id",
            "realm"
          ]
        }
      }
    },
    "mozcloud-gateway-lib": {
      "type": "object"
    },
    "mozcloud-ingress-lib": {
      "type": "object"
    },
    "mozcloud-labels-lib": {
      "type": "object"
    },
    "enabled": {
      "type": "boolean",
      "default": true
    },
    "configMaps": {
      "type": "object",
      "description": "ConfigMaps available to workloads/jobs",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "annotations": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            }
          },
          "data": {
            "type": "object",
            "additionalProperties": {
              "oneOf": [
                {
                  "type": "string"
                },
                {
                  "type": "number"
                }
              ]
            }
          }
        }
      }
    },
    "externalSecrets": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "gsmSecretName": {
            "type": "string"
          },
          "version": {
            "type": "string",
            "default": "latest"
          }
        },
        "required": ["gsmSecretName"]
      }
    },
    "persistentVolumes": {
      "type": "object",
      "description": "PersistentVolumeClaims available to workloads/jobs",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "accessModes": {
            "type": "string",
            "enum": [
              "ReadWriteOnce",
              "ReadOnlyMany",
              "ReadWriteMany"
            ],
            "default": "ReadWriteOnce"
          },
          "size": {
            "type": "string",
            "pattern": "^\\d+(K|Ki|M|Mi|G|Gi)$"
          },
          "storageClassName": {
            "type": "string"
          }
        },
        "required": [
          "accessModes",
          "size",
          "storageClassName"
        ]
      }
    },
    "serviceAccounts": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "gcpServiceAccount": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "name": {
                "type": "string"
              },
              "projectId": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "tasks": {
      "type": "object",
      "description": "Declarative tasks broken down by common, cron job, and job configurations",
      "properties": {
        "common": {
          "type": "object",
          "description": "Common configurations for containers, cron jobs, and jobs",
          "additionalProperties": false,
          "properties": {
            "container": {
              "$ref": "#/$defs/container"
            },
            "cronJob": {
              "$ref": "#/$defs/cronJob"
            },
            "job": {
              "allOf": [
                {
                  "$ref": "#/$defs/job"
                },
                {
                  "type": "object",
                  "properties": {
                    "type": {
                      "type": "string",
                      "enum": [
                        "preDeployment",
                        "postDeployment"
                      ]
                    }
                  }
                }
              ]
            }
          }
        },
        "cronJobs": {
          "type": "object",
          "description": "Declarative cron jobs keyed by cron job name",
          "additionalProperties": {
            "allOf": [
              {
                "$ref": "#/$defs/cronJob"
              },
              {
                "type": "object",
                "properties": {
                  "jobConfig": {
                    "allOf": [
                      {
                        "$ref": "#/$defs/job"
                      },
                      {
                        "type": "object",
                        "properties": {
                          "containers": {
                            "type": "object",
                            "additionalProperties": {
                              "$ref": "#/$defs/container"
                            }
                          }
                        }
                      }
                    ]
                  }
                }
              }
            ]
          }
        },
        "jobs": {
          "type": "object",
          "description": "Declarative jobs keyed by job name",
          "additionalProperties": {
            "allOf": [
              {
                "$ref": "#/$defs/job"
              },
              {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": [
                      "preDeployment",
                      "postDeployment"
                    ]
                  },
                  "argo": {
                    "type": "object",
                    "properties": {
                      "syncWave": {
                        "type": "integer"
                      }
                    }
                  },
                  "containers": {
                    "type": "object",
                    "additionalProperties": {
                      "$ref": "#/$defs/container"
                    }
                  }
                },
                "required": ["type", "containers"]
              }
            ]
          }
        }
      }
    },
    "workloads": {
      "type": "object",
      "description": "Declarative workloads keyed by workload name",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "component": {
            "type": "string"
          },
          "autoscaling": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "enabled": {
                "type": "boolean",
                "default": true
              },
              "metrics": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "type": {
                      "type": "string",
                      "enum": [
                        "cpu",
                        "memory",
                        "network"
                      ]
                    },
                    "threshold": {
                      "type": "integer",
                      "minimum": 0,
                      "maximum": 100,
                      "description": "Average percent utilization"
                    },
                    "customMetric": {
                      "type": "string",
                      "description": "Only applicable when type=network"
                    }
                  },
                  "required": [
                    "type",
                    "threshold"
                  ]
                }
              },
              "replicas": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "min": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1
                  },
                  "max": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 30
                  }
                }
              }
            }
          },
          "containers": {
            "type": "object",
            "description": "Declarative containers keyed by container name",
            "additionalProperties": {
              "allOf": [
                {
                  "$ref": "#/$defs/container"
                }
              ],
              "properties": {
                "healthCheck": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "readiness": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "default": true
                        },
                        "path": {
                          "type": "string",
                          "default": "/__lbheartbeat__"
                        },
                        "httpHeaders": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                              "name": {
                                "type": "string"
                              },
                              "value": {
                                "type": "string"
                              }
                            }
                          }
                        },
                        "probes": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "initialDelaySeconds": {
                              "type": "integer",
                              "minimum": 0,
                              "default": 10
                            },
                            "periodSeconds": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 6
                            },
                            "timeoutSeconds": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 5
                            },
                            "successThreshold": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 1
                            },
                            "failureThreshold": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 3
                            }
                          }
                        }
                      }
                    },
                    "liveness": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "default": true
                        },
                        "path": {
                          "type": "string",
                          "default": "/__lbheartbeat__"
                        },
                        "httpHeaders": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                              "name": {
                                "type": "string"
                              },
                              "value": {
                                "type": "string"
                              }
                            }
                          }
                        },
                        "probes": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "initialDelaySeconds": {
                              "type": "integer",
                              "minimum": 0,
                              "default": 10
                            },
                            "periodSeconds": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 6
                            },
                            "timeoutSeconds": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 5
                            },
                            "successThreshold": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 1
                            },
                            "failureThreshold": {
                              "type": "integer",
                              "minimum": 1,
                              "default": 5
                            }
                          }
                        }
                      }
                    },
                    "metrics": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "path": {
                          "type": "string",
                          "default": "/metrics"
                        }
                      }
                    }
                  }
                },
                "port": {
                  "type": "integer",
                  "default": 8000
                }
              }
            }
          },
          "hosts": {
            "type": "object",
            "additionalProperties": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "disableGateway": {
                  "type": "boolean"
                },
                "domains": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "addresses": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "httpRoutes": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "createHttpRoutes": {
                      "type": "boolean"
                    },
                    "rules": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                          "backendRefs": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "additionalProperties": false,
                              "properties": {
                                "kind": {
                                  "type": "string"
                                },
                                "name": {
                                  "type": "string"
                                },
                                "port": {
                                  "anyOf": [
                                    {
                                      "type": "string"
                                    },
                                    {
                                      "type": "number"
                                    }
                                  ]
                                },
                                "weight": {
                                  "type": "number"
                                }
                              }
                            }
                          },
                          "matches": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "additionalProperties": false,
                              "properties": {
                                "path": {
                                  "type": "object",
                                  "additionalProperties": false,
                                  "properties": {
                                    "value": {
                                      "type": "string"
                                    },
                                    "type": {
                                      "type": "string",
                                      "default": "PathPrefix"
                                    }
                                  }
                                },
                                "headers": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "additionalProperties": false,
                                    "properties": {
                                      "name": {
                                        "type": "string"
                                      },
                                      "value": {
                                        "type": "string"
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "backends": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "service": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                          "portName": {
                            "type": "string"
                          },
                          "port": {
                            "type": "number"
                          },
                          "targetPort": {
                            "anyOf": [
                              {
                                "type": "number"
                              },
                              {
                                "type": "string"
                              }
                            ]
                          },
                          "createServiceExport": {
                            "type": "boolean"
                          }
                        }
                      },
                      "disableBackendPolicy": {
                        "type": "boolean"
                      },
                      "disableHealthCheck": {
                        "type": "boolean"
                      },
                      "backendPolicy": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                          "targetRef": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                              "kind": {
                                "type": "string"
                              },
                              "name": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      },
                      "healthCheck": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                          "path": {
                            "type": "string"
                          },
                          "host": {
                            "type": "string"
                          },
                          "port": {
                            "anyOf": [
                              {
                                "type": "string"
                              },
                              {
                                "type": "number"
                              }
                            ]
                          },
                          "targetRef": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                              "kind": {
                                "type": "string"
                              },
                              "name": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "api": {
                  "type": "string",
                  "enum": [
                    "gateway",
                    "ingress"
                  ],
                  "default": "gateway"
                },
                "multiCluster": {
                  "type": "boolean",
                  "default": false
                },
                "type": {
                  "type": "string",
                  "enum": [
                    "internal",
                    "external"
                  ],
                  "default": "external"
                },
                "tls": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "certs": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "create": {
                      "type": "boolean",
                      "default": true
                    },
                    "type": {
                      "type": "string",
                      "enum": [
                        "certmap",
                        "ManagedCertificate",
                        "pre-shared"
                      ],
                      "default": "certmap"
                    }
                  }
                },
                "options": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "createBackendPolicy": {
                      "type": "boolean"
                    },
                    "iap": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "enabled": {
                          "type": "boolean",
                          "default": false
                        },
                        "oauth2ClientId": {
                          "type": "string"
                        },
                        "oauth2ClientSecret": {
                          "type": "string"
                        }
                      }
                    },
                    "logSampleRate": {
                      "type": [
                        "number",
                        "integer",
                        "string"
                      ],
                      "default": 10
                    },
                    "timeoutSec": {
                      "type": "integer",
                      "minimum": 0,
                      "default": 30
                    },
                    "healthCheck": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "path": {
                          "type": "string"
                        },
                        "port": {
                          "anyOf": [
                            {
                              "type": "string"
                            },
                            {
                              "type": "number"
                            }
                          ]
                        },
                        "host": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              },
              "required": [
                "domains"
              ]
            }
          },
          "initContainers": {
            "type": "object",
            "description": "Declarative init containers keyed by container name",
            "additionalProperties": {
              "allOf": [
                {
                  "$ref": "#/$defs/container"
                },
                {
                  "type": "object",
                  "properties": {
                    "sidecar": {
                      "type": "boolean",
                      "default": false
                    }
                  }
                }
              ]
            }
          },
          "labels": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            }
          },
          "nginx": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "enabled": {
                "type": "boolean",
                "default": true
              },
              "image": {
                "type": "string"
              },
              "configMap": {
                "type": "string"
              },
              "resources": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "cpu": {
                    "type": "string",
                    "pattern": "^(\\d+|\\d+m)$"
                  },
                  "memory": {
                    "type": "string",
                    "pattern": "^\\d+(K|Ki|M|Mi|G|Gi)$"
                  }
                }
              }
            }
          },
          "otel": {
            "$ref": "#/$defs/otel"
          },
          "security": {
            "$ref": "#/$defs/podSecurity"
          },
          "serviceAccount": {
            "type": "string"
          },
          "strategy": {
            "type": "string",
            "enum": [
              "Recreate",
              "RollingUpdate"
            ]
          },
          "terminationGracePeriodSeconds": {
            "type": "integer",
            "minimum": 1,
            "default": 30
          }
        },
        "required": [
          "component",
          "containers"
        ]
      }
    }
  },
  "$defs": {
    "container": {
      "type": "object",
      "properties": {
        "args": {
          "oneOf": [
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            {
              "type": "string"
            }
          ]
        },
        "command": {
          "oneOf": [
            {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            {
              "type": "string"
            }
          ]
        },
        "configMaps": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "envVars": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "externalSecrets": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "image": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "repository": {
              "type": "string"
            },
            "tag": {
              "type": "string"
            }
          }
        },
        "resources": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cpu": {
              "type": "string",
              "description": "Integer cores (e.g., 2) or millicores (e.g., 200m)",
              "pattern": "^(\\d+|\\d+m)$",
              "default": "100m"
            },
            "memory": {
              "type": "string",
              "description": "K, Ki, M, Mi, G, or Gi (recommend binary units)",
              "pattern": "^\\d+(K|Ki|M|Mi|G|Gi)$",
              "default": "128Mi"
            }
          }
        },
        "security": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "uid": {
              "type": "integer",
              "minimum": 0
            },
            "gid": {
              "type": "integer",
              "minimum": 0
            },
            "addCapabilities": {
              "type": "array"
            }
          }
        },
        "volumes": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string",
                "enum": [
                  "configMap",
                  "secret",
                  "persistentVolumeClaim",
                  "emptyDir"
                ]
              },
              "path": {
                "type": "string"
              },
              "key": {
                "type": "string"
              },
              "readOnly": {
                "type": "boolean"
              },
              "create": {
                "type": "boolean",
                "default": false
              },
              "accessModes": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": [
                    "ReadWriteOnce",
                    "ReadOnlyMany",
                    "ReadWriteMany"
                  ]
                },
                "default": "ReadWriteOnce"
              },
              "size": {
                "type": "string",
                "pattern": "^\\d+(K|Ki|M|Mi|G|Gi)$"
              },
              "storageClassName": {
                "type": "string"
              },
              "medium": {
                "type": "string",
                "enum": [
                  "Memory"
                ]
              },
              "sizeLimit": {
                "type": "string",
                "pattern": "^\\d+(K|Ki|M|Mi|G|Gi)$"
              }
            },
            "required": [
              "name",
              "type",
              "path"
            ],
            "allOf": [
              {
                "if": {
                  "properties": {
                    "type": {
                      "const": "persistentVolumeClaim"
                    }
                  }
                },
                "then": {
                  "required": [
                    "accessModes",
                    "size"
                  ]
                }
              },
              {
                "if": {
                  "properties": {
                    "medium": {
                      "const": "Memory"
                    }
                  },
                  "required": [
                    "medium"
                  ]
                },
                "then": {
                  "required": [
                    "sizeLimit"
                  ]
                }
              }
            ]
          }
        }
      }
    },
    "cronJob": {
      "type": "object",
      "properties": {
        "jobHistory": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "successful": {
              "type": "number"
            },
            "failed": {
              "type": "number"
            }
          }
        },
        "schedule": {
          "type": "string"
        },
        "suspend": {
          "type": "boolean"
        }
      },
      "required": ["schedule"]
    },
    "job": {
      "type": "object",
      "properties": {
        "generateName": {
          "type": "boolean"
        },
        "activeDeadlineSeconds": {
          "type": "integer"
        },
        "backoffLimit": {
          "type": "integer",
          "default": 6
        },
        "otel": {
          "$ref": "#/$defs/otel"
        },
        "parallelism": {
          "type": "integer",
          "minimum": 1,
          "default": 1
        },
        "restartPolicy": {
          "type": "string",
          "enum": [
            "Never",
            "OnFailure"
          ],
          "default": "Never"
        },
        "security": {
          "$ref": "#/$defs/podSecurity"
        },
        "serviceAccount": {
          "type": "string"
        },
        "suspend": {
          "type": "boolean"
        },
        "ttlSecondsAfterFinished": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "otel": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "containers": {
          "type": "array",
          "default": []
        },
        "autoInstrumentation": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "language": {
              "type": "string",
              "enum": [
                "",
                "dotnet",
                "go",
                "java",
                "nodejs",
                "python"
              ]
            }
          }
        }
      }
    },
    "podSecurity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "runAsRoot": {
          "type": "boolean",
          "default": false
        }
      }
    }
  }
}
