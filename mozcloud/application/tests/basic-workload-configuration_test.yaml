---
suite: "mozcloud: Basic workload configuration"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
# By overriding the chart version, we are preventing the labels chart from
# updating the mozcloud_chart_version label for every snapshot every time we
# bump chart versions.
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/basic-configuration.yaml
templates:
  - externalsecret/externalsecret.yaml
  - serviceaccount/serviceaccount.yaml
  - workload/workload.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: External secret is configured correctly
    template: externalsecret/externalsecret.yaml
    documentSelector:
      path: $[?(@.kind == "ExternalSecret")].metadata.name
      value: mozcloud-test-test-chart-secrets
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
      - contains:
          path: spec.dataFrom
          content:
            extract:
              conversionStrategy: Default
              decodingStrategy: None
              key: dev-gke-app-secrets
              metadataPolicy: None
              version: latest
      - equal:
          path: spec.refreshInterval
          value: 5m
      - isSubset:
          path: spec.secretStoreRef
          content:
            kind: SecretStore
            name: secret-store
      - equal:
          path: spec.target.name
          value: mozcloud-test-secrets
  - it: Service account is configured correctly
    template: serviceaccount/serviceaccount.yaml
    documentSelector:
      path: $[?(@.kind == "ServiceAccount")].metadata.name
      value: mozcloud-test
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
      - exists:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: gke-dev@moz-fx-mozcloud-test-nonprod.iam.gserviceaccount.com
  - it: Deployment (containers excluded) is configured correctly
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-service
    asserts:
      - exists:
          path: spec.selector.matchLabels
      - isNotNullOrEmpty:
          path: spec.selector.matchLabels
      - lengthEqual:
          path: spec.template.spec.containers
          count: 2
      - isSubset:
          path: spec.template.spec.securityContext
          content:
            runAsGroup: 10001
            runAsNonRoot: true
            runAsUser: 10001
            seccompProfile:
              type: RuntimeDefault
      - equal:
          path: spec.template.spec.serviceAccountName
          value: mozcloud-test
      - lengthEqual:
          path: spec.template.spec.volumes
          count: 6
      - isSubset:
          path: spec.template.spec.volumes[0]
          content:
            configMap:
              name: test-service-nginx
            name: nginx-conf
      - isSubset:
          path: spec.template.spec.volumes[1]
          content:
            configMap:
              name: test-service-configmap
            name: test-service-configmap
      - isSubset:
          path: spec.template.spec.volumes[2]
          content:
            emptyDir: {}
            name: test-service-empty
      - isSubset:
          path: spec.template.spec.volumes[3]
          content:
            name: test-service-memory
            emptyDir:
              medium: Memory
              sizeLimit: 500Mi
      - isSubset:
          path: spec.template.spec.volumes[4]
          content:
            persistentVolumeClaim:
              claimName: test-service-pvc
            name: test-service-pvc
      - isSubset:
          path: spec.template.spec.volumes[5]
          content:
            secret:
              name: test-service-secret
            name: test-service-secret
  - it: Deployment (app container) is configured correctly
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-service
    asserts:
      - contains:
          path: spec.template.spec.containers[1].envFrom
          content:
            secretRef:
              name: mozcloud-test-secrets
      - equal:
          path: spec.template.spec.containers[1].image
          value: test-repo/test-image:1.0.0
      - equal:
          path: spec.template.spec.containers[1].imagePullPolicy
          value: Always
      - isSubset:
          path: spec.template.spec.containers[1].readinessProbe
          content:
            failureThreshold: 3
            httpGet:
              path: /__lbheartbeat__
              port: app
            initialDelaySeconds: 10
            periodSeconds: 6
            successThreshold: 1
            timeoutSeconds: 5
      - isSubset:
          path: spec.template.spec.containers[1].livenessProbe
          content:
            failureThreshold: 5
            httpGet:
              path: /__lbheartbeat__
              port: app
            initialDelaySeconds: 10
            periodSeconds: 6
            successThreshold: 1
            timeoutSeconds: 5
      - equal:
          path: spec.template.spec.containers[1].name
          value: app
      - lengthEqual:
          path: spec.template.spec.containers[1].ports
          count: 1
      - isSubset:
          path: spec.template.spec.containers[1].ports[0]
          content:
            containerPort: 8000
            name: app
      - isSubset:
          path: spec.template.spec.containers[1].resources
          content:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 100m
              memory: 128Mi
      - isSubset:
          path: spec.template.spec.containers[1].securityContext
          content:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
  - it: Deployment (nginx container) is configured correctly
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-service
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: us-west1-docker.pkg.dev/moz-fx-platform-artifacts/platform-dockerhub-cache/nginxinc/nginx-unprivileged:1.29
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
      - isSubset:
          path: spec.template.spec.containers[0].lifecycle
          content:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - -c
                  - /bin/sleep 25 && /usr/sbin/nginx -s quit
      - isSubset:
          path: spec.template.spec.containers[0].readinessProbe
          content:
            failureThreshold: 3
            httpGet:
              path: /__lbheartbeat__
              port: http
            initialDelaySeconds: 10
            periodSeconds: 6
            successThreshold: 1
            timeoutSeconds: 5
      - isSubset:
          path: spec.template.spec.containers[0].livenessProbe
          content:
            failureThreshold: 5
            httpGet:
              path: /__nginxheartbeat__
              port: http
            initialDelaySeconds: 10
            periodSeconds: 6
            successThreshold: 1
            timeoutSeconds: 5
      - equal:
          path: spec.template.spec.containers[0].name
          value: nginx
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 1
      - isSubset:
          path: spec.template.spec.containers[0].ports[0]
          content:
            containerPort: 8080
            name: http
            protocol: TCP
      - isSubset:
          path: spec.template.spec.containers[0].resources
          content:
            limits:
              cpu: 100m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
      - isSubset:
          path: spec.template.spec.containers[0].securityContext
          content:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsGroup: 101
            runAsUser: 101
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 1
      - isSubset:
          path: spec.template.spec.containers[0].volumeMounts[0]
          content:
            mountPath: /etc/nginx/nginx.conf
            name: nginx-conf
            readOnly: true
            subPath: nginx.conf
  - it: NGINX config map is configured correctly
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "ConfigMap")].metadata.name
      value: test-service-nginx
    asserts:
      - isNotNullOrEmpty:
          path: data["nginx.conf"]
  - it: HPA is configured correctly
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "HorizontalPodAutoscaler")].metadata.name
      value: test-service
    asserts:
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 30
      - lengthEqual:
          path: spec.metrics
          count: 1
      - equal:
          path: spec.metrics[0].resource.name
          value: cpu
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 60
      - isSubset:
          path: spec.scaleTargetRef
          content:
            apiVersion: apps/v1
            kind: Deployment
            name: test-service
  - it: Schema rejects emptyDir with medium Memory but no sizeLimit
    template: workload/workload.yaml
    set:
      workloads.test-service.containers.app.volumes:
        - name: bad-volume
          type: emptyDir
          path: /tmp/bad
          medium: Memory
    asserts:
      - failedTemplate:
          errorPattern: missing property 'sizeLimit'
