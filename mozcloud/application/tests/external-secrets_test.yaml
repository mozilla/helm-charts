---
suite: "mozcloud: External secrets"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
# By overriding the chart version, we are preventing the labels chart from
# updating the mozcloud_chart_version label for every snapshot every time we
# bump chart versions.
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/external-secrets.yaml
templates:
  - externalsecret/externalsecret.yaml
  - workload/workload.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: Default external secret configured correctly
    template: externalsecret/externalsecret.yaml
    documentSelector:
      path: $[?(@.kind == "ExternalSecret")].metadata.name
      value: test-chart-secrets
    asserts:
      - equal:
          path: spec.target.name
          value: test-chart-secrets
      - equal:
          path: spec.dataFrom[0].extract.key
          value: dev-gke-app-secrets
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
  - it: Custom external secret configured correctly
    template: externalsecret/externalsecret.yaml
    documentSelector:
      path: $[?(@.kind == "ExternalSecret")].metadata.name
      value: test-k8s-secret
    asserts:
      - equal:
          path: spec.target.name
          value: test-k8s-secret
      - equal:
          path: spec.dataFrom[0].extract.key
          value: dev-gke-test-custom-secrets
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
  - it: Default secret in app container
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-service
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name=="app")].envFrom[0].secretRef.name
          value: mozcloud-test-secrets
      - lengthEqual:
          path: spec.template.spec.containers[?(@.name=="app")].envFrom
          count: 1
  - it: Default and custom secrets in custom container
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-service
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name=="custom")].envFrom[0].secretRef.name
          value: mozcloud-test-secrets
      - equal:
          path: spec.template.spec.containers[?(@.name=="custom")].envFrom[1].secretRef.name
          value: test-k8s-secret
      - lengthEqual:
          path: spec.template.spec.containers[?(@.name=="custom")].envFrom
          count: 2
