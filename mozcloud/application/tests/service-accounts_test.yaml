---
suite: "mozcloud: Service accounts"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
# By overriding the chart version, we are preventing the labels chart from
# updating the mozcloud_chart_version label for every snapshot every time we
# bump chart versions.
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/service-accounts.yaml
templates:
  - serviceaccount/serviceaccount.yaml
  - workload/workload.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: Default service account configured correctly
    template: serviceaccount/serviceaccount.yaml
    documentSelector:
      path: $[?(@.kind == "ServiceAccount")].metadata.name
      value: mozcloud-test
    asserts:
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: gke-dev@moz-fx-mozcloud-test-nonprod.iam.gserviceaccount.com
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
  - it: Custom service account (same project) configured correctly
    template: serviceaccount/serviceaccount.yaml
    documentSelector:
      path: $[?(@.kind == "ServiceAccount")].metadata.name
      value: test-k8s-service-account-my-project
    asserts:
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: test-service-nonprod-dev@moz-fx-mozcloud-test-nonprod.iam.gserviceaccount.com
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
  - it: Custom service account (different project) configured correctly
    template: serviceaccount/serviceaccount.yaml
    documentSelector:
      path: $[?(@.kind == "ServiceAccount")].metadata.name
      value: test-k8s-service-account-different-project
    asserts:
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: different-service-nonprod-dev@moz-fx-different-project-nonprod.iam.gserviceaccount.com
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-11"
  - it: Default deployment uses default service account
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: default
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: mozcloud-test
  - it: First custom deployment uses custom service account from same project
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: custom-my-project
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: test-k8s-service-account-my-project
  - it: Second custom deployment uses custom service account from different project
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: custom-different-project
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: test-k8s-service-account-different-project
