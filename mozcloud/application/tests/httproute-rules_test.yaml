---
suite: "mozcloud: HTTPRoute rules"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
# By overriding the chart version, we are preventing the labels chart from
# updating the mozcloud_chart_version label for every snapshot every time we
# bump chart versions.
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/httproute-rules.yaml
templates:
  - gateway/gateway.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: Header-only HTTPRoute is configured with correct rules
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: header-only
    asserts:
      - contains:
          path: spec.rules[0].backendRefs
          content:
            group: ""
            kind: Service
            name: test-service
            port: 8080
      - contains:
          path: spec.rules[0].matches
          content:
            headers:
              - name: foo
                value: bar
  - it: Path-only HTTPRoute is configured with correct rules
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: path-only
    asserts:
      - contains:
          path: spec.rules[0].backendRefs
          content:
            group: ""
            kind: Service
            name: test-service
            port: 8080
      - contains:
          path: spec.rules[0].matches
          content:
            path:
              type: PathPrefix
              value: /foo
  - it: Headers and path HTTPRoute is configured with correct rules
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: headers-and-path
    asserts:
      - contains:
          path: spec.rules[0].backendRefs
          content:
            group: ""
            kind: Service
            name: test-service
            port: 8080
      - contains:
          path: spec.rules[0].matches
          content:
            headers:
              - name: foo
                value: bar
              - name: baz
                value: qux
            path:
              type: PathPrefix
              value: /foo
