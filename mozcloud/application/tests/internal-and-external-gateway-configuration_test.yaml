---
suite: "mozcloud: Internal and external gateway configuration"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/internal-and-external-gateway-configuration.yaml
templates:
  - gateway/gateway.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: Creates two gateways (internal and external)
    asserts:
      - hasDocuments:
          count: 12
  - it: External gateway is configured correctly
    documentSelector:
      path: $[?(@.kind == "Gateway")].metadata.name
      value: mozcloud-test-external
    asserts:
      - equal:
          path: metadata.name
          value: mozcloud-test-external
      - equal:
          path: metadata.annotations["networking.gke.io/certmap"]
          value: test-service-nonprod-dev
      - equal:
          path: spec.gatewayClassName
          value: gke-l7-global-external-managed
      - contains:
          path: spec.addresses
          count: 1
          content:
            type: NamedAddress
            value: mozcloud-dev-external-ip-v4
      - lengthEqual:
          path: spec.listeners
          count: 2
      - contains:
          path: spec.listeners
          count: 1
          content:
            allowedRoutes:
              namespaces:
                from: Same
            name: http
            port: 80
            protocol: HTTP
      - contains:
          path: spec.listeners
          count: 1
          content:
            allowedRoutes:
              namespaces:
                from: Same
            name: https
            port: 443
            protocol: HTTPS
  - it: Internal gateway is configured correctly
    documentSelector:
      path: $[?(@.kind == "Gateway")].metadata.name
      value: mozcloud-test-internal
    asserts:
      - equal:
          path: metadata.name
          value: mozcloud-test-internal
      - equal:
          path: spec.gatewayClassName
          value: gke-l7-global-external-managed
      - contains:
          path: spec.addresses
          count: 1
          content:
            type: NamedAddress
            value: mozcloud-dev-internal-ip-v4
      - lengthEqual:
          path: spec.listeners
          count: 1
      - contains:
          path: spec.listeners
          count: 1
          content:
            allowedRoutes:
              namespaces:
                from: Same
            name: http
            port: 80
            protocol: HTTP
      - notExists:
          path: metadata.annotations["networking.gke.io/certmap"]
  - it: External gateway policy is configured correctly
    documentSelector:
      path: $[?(@.kind == "GCPGatewayPolicy")].metadata.name
      value: mozcloud-test-external
    asserts:
      - equal:
          path: spec.default.sslPolicy
          value: mozilla-intermediate
      - equal:
          path: spec.targetRef.name
          value: mozcloud-test-external
  - it: Only external gateway policy exists (internal has no HTTPS listener)
    asserts:
      - documentIndex: 2
        equal:
          path: kind
          value: GCPGatewayPolicy
      - documentIndex: 2
        equal:
          path: metadata.name
          value: mozcloud-test-external
  - it: External HTTPRoute references external gateway
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: external-host
    asserts:
      - contains:
          path: spec.hostnames
          count: 1
          content: external.test-domain.com
      - contains:
          path: spec.parentRefs
          count: 1
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: mozcloud-test-external
            sectionName: https
  - it: External HTTPRoute has HTTP redirect
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: external-host-http-redirect
    asserts:
      - contains:
          path: spec.parentRefs
          count: 1
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: mozcloud-test-external
            sectionName: http
  - it: Internal HTTPRoute references internal gateway
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: internal-host
    asserts:
      - contains:
          path: spec.hostnames
          count: 1
          content: internal.test-domain.local
      - contains:
          path: spec.parentRefs
          count: 1
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: mozcloud-test-internal
            sectionName: http
      - lengthEqual:
          path: spec.parentRefs
          count: 1
