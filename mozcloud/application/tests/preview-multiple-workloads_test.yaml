---
suite: "mozcloud: Preview mode with multiple workloads"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/preview-multiple-workloads.yaml
set:
  preview.enabled: true
  preview.pr: "456"
  preview.host: "pr456-test.preview.mozilla.cloud"
templates:
  - preview/httpRoute.yaml
  - preview/endpointCheck.yaml
  - workload/workload.yaml
tests:
  # Test that all three workload deployments are created with correct prefixes
  - it: API deployment is prefixed with PR number
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment" && @.metadata.name == "pr456-api-service")]
    asserts:
      - equal:
          path: metadata.name
          value: pr456-api-service

  - it: Web deployment is prefixed with PR number
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment" && @.metadata.name == "pr456-web-service")]
    asserts:
      - equal:
          path: metadata.name
          value: pr456-web-service

  - it: Admin deployment is prefixed with PR number
    template: workload/workload.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment" && @.metadata.name == "pr456-admin-service")]
    asserts:
      - equal:
          path: metadata.name
          value: pr456-admin-service

  # Test API HTTPRoute configuration
  - it: API HTTPRoute has correct preview hostname
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "api-host")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "api-pr456-test.preview.mozilla.cloud"

  - it: API HTTPRoute uses shared preview gateway
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "api-host")]
    asserts:
      - isSubset:
          path: spec.parentRefs[0]
          content:
            name: sandbox-high-preview-gateway
            namespace: preview-shared-infrastructure

  - it: API HTTPRoute routes to prefixed service
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "api-host")]
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: pr456-api-service

  - it: API HTTPRoute has correct component label
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "api-host")]
    asserts:
      - equal:
          path: metadata.labels.component_code
          value: api

  # Test Web HTTPRoute configuration
  - it: Web HTTPRoute has correct preview hostname
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "web-host")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "web-pr456-test.preview.mozilla.cloud"

  - it: Web HTTPRoute uses shared preview gateway
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "web-host")]
    asserts:
      - isSubset:
          path: spec.parentRefs[0]
          content:
            name: sandbox-high-preview-gateway
            namespace: preview-shared-infrastructure

  - it: Web HTTPRoute routes to prefixed service
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "web-host")]
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: pr456-web-service

  - it: Web HTTPRoute has correct component label
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "web-host")]
    asserts:
      - equal:
          path: metadata.labels.component_code
          value: web

  # Test Admin HTTPRoute configuration
  - it: Admin HTTPRoute has correct preview hostname
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "admin-host")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "admin-pr456-test.preview.mozilla.cloud"

  - it: Admin HTTPRoute uses shared preview gateway
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "admin-host")]
    asserts:
      - isSubset:
          path: spec.parentRefs[0]
          content:
            name: sandbox-high-preview-gateway
            namespace: preview-shared-infrastructure

  - it: Admin HTTPRoute routes to prefixed service
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "admin-host")]
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: pr456-admin-service

  - it: Admin HTTPRoute has correct component label
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "admin-host")]
    asserts:
      - equal:
          path: metadata.labels.component_code
          value: admin

  # Test HTTP redirect routes are also created
  - it: API HTTP to HTTPS redirect route is created
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "api-host-http-redirect")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "api-pr456-test.preview.mozilla.cloud"
      - equal:
          path: spec.rules[0].filters[0].type
          value: RequestRedirect
      - equal:
          path: spec.rules[0].filters[0].requestRedirect.scheme
          value: https

  - it: Web HTTP to HTTPS redirect route is created
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "web-host-http-redirect")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "web-pr456-test.preview.mozilla.cloud"

  - it: Admin HTTP to HTTPS redirect route is created
    template: preview/httpRoute.yaml
    documentSelector:
      path: $[?(@.kind == "HTTPRoute" && @.metadata.name == "admin-host-http-redirect")]
    asserts:
      - contains:
          path: spec.hostnames
          content: "admin-pr456-test.preview.mozilla.cloud"

  # Test endpoint check validates all hostnames
  - it: Endpoint check job is created
    template: preview/endpointCheck.yaml
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.annotations["argocd.argoproj.io/hook"]
          value: PostSync

  - it: Endpoint check validates all three hostnames
    template: preview/endpointCheck.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[2]
          pattern: "admin-pr456-test.preview.mozilla.cloud"
      - matchRegex:
          path: spec.template.spec.containers[0].args[2]
          pattern: "api-pr456-test.preview.mozilla.cloud"
      - matchRegex:
          path: spec.template.spec.containers[0].args[2]
          pattern: "web-pr456-test.preview.mozilla.cloud"

  - it: Endpoint check reports correct count
    template: preview/endpointCheck.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[2]
          pattern: "Checking 3 endpoint"
      - matchRegex:
          path: spec.template.spec.containers[0].args[2]
          pattern: "All 3 endpoint"
