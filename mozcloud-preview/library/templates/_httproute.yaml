{{- define "mozcloud-preview-lib.httpRoute" -}}
{{- $rawRoutes := .httpRouteConfig.httpRoutes }}
{{- $previewHost := .previewHost }}

{{- $transformedRoutes := list }}
{{- range $route := $rawRoutes }}
  {{- $newHostnames := list }}
  {{- if eq (len $route.hostnames) 1 }}
    {{- $newHostnames = list $previewHost }}
  {{- else }}
    {{- range $hostname := $route.hostnames }}
      {{- $prefix := first (splitList "." (print $hostname)) }}
      {{- $newHostnames = append $newHostnames (printf "%s-%s" $prefix $previewHost) }}
    {{- end }}
  {{- end }}

  {{- $updatedRoute := deepCopy $route | merge (dict "hostnames" $newHostnames) }}
  {{- $transformedRoutes = append $transformedRoutes $updatedRoute }}
{{- end }}

{{- $transformedConfig := dict "httpRoutes" $transformedRoutes }}

{{- include "mozcloud-gateway-lib.httpRoute" (merge . (dict "httpRouteConfig" $transformedConfig)) }}
{{- end }}