{{- define "mozcloud-preview-lib.httpRoute" -}}
{{- if .httpRouteConfig.enabled }}
{{- $rawRoutes := .httpRouteConfig.httpRoutes }}
{{- $previewHost := .previewHost }}
{{- $previewPr := .previewPr }}
{{- $transformedRoutes := dict }}

{{- /* $name here has already been transformed to contain the pr name */ -}}
{{- range $name, $route := $rawRoutes }}
  {{- $newHostnames := list }}

  {{- range $i, $hostname := $route.hostnames }}
    {{- $prefix := first (splitList "." (print $hostname)) }}

    {{- $prefixed := "" -}}
    {{- if gt (len $rawRoutes) 1 }}
      {{- $prefixed = printf "%s-%s" $prefix $previewHost }}
    {{- else }}
      {{- $prefixed = printf "%s" $previewHost }}
    {{- end }}

    {{- $newHostnames = append $newHostnames $prefixed }}
  {{- end }}

  {{- $transformedRules := list -}}
  {{- range $r := $route.rules }}
    {{- $newBackendRefs := list -}}
    {{- range $br := $r.backendRefs }}
      {{- $backendName := (include "mozcloud-preview-lib.config.pr-prefix" (dict "pr" $previewPr "value" $br.name)) }}
      {{- $newBackendRefs = append $newBackendRefs (mergeOverwrite (deepCopy $br) (dict "name" $backendName)) -}}
    {{- end }}
    {{- $transformedRule := mergeOverwrite (deepCopy $r) (dict "backendRefs" $newBackendRefs) -}}
    {{- $transformedRules = append $transformedRules $transformedRule -}}
  {{- end }}

  {{- $updatedRoute := mergeOverwrite (deepCopy $route) (dict
    "hostnames" $newHostnames
    "gatewayRefs" (list (dict
      "name" "sandbox-high-preview-gateway"
      "namespace" "preview-shared-infrastructure"
      "section"   "https"
    ))
    "rules" $transformedRules
  ) }}
  {{- $_ := set $transformedRoutes $name $updatedRoute }}

{{- end }}

{{- $transformedConfig := dict "httpRoutes" $transformedRoutes }}

{{- include "mozcloud-gateway-lib.httpRoute" (mergeOverwrite (omit . "httpRouteConfig") (dict "httpRouteConfig" $transformedConfig)) }}

{{- end }}
{{- end }}
