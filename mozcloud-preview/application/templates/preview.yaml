{{- if .Values.enabled }}
{{- $previewPr := .Values.global.preview.pr | toString }}
{{- $httpRoutes := list }}
{{- range .Values.httpRoute.httpRoutes }}
  {{- $route := deepCopy . }}
  {{- $_ := set $route "name" (printf "pr%s-%s" $previewPr .name) }}
  {{- $httpRoutes = append $httpRoutes $route }}
{{- end }}

{{- $httpRouteConfig := dict
    "enabled" .Values.httpRoute.enabled
    "httpRoutes" $httpRoutes
}}

{{- $transformedBackends := list }}
{{- range .Values.backends }}
  {{- $be := deepCopy . }}
  {{- $base := default (dict) $be.service.selectorLabels -}}
  {{- $labels := merge (dict) $base -}}
  {{- $_ := set $labels "app.preview/pr" $previewPr -}}
  {{- $_ := set $be.service "selectorLabels" $labels -}}
  {{- $transformedBackends = append $transformedBackends $be -}}
{{- end }}

{{- $params := dict
    "httpRouteConfig" $httpRouteConfig
    "backendConfig" (dict "backends" $transformedBackends)
    "nameOverride" (printf "pr%s-%s" $previewPr (include "mozcloud-preview.name" .))
    "Chart" .Chart
    "Release" .Release
    "previewPr" $previewPr
    "previewHost" (.Values.global.preview.host | toString)
}}

{{- include "mozcloud-preview-lib.httpRoute" $params }}
{{- include "mozcloud-preview-lib.endpointcheck" $params }}
{{- include "mozcloud-gateway-lib.service" $params }}
{{- end }}
