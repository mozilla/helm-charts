{{- if .Values.enabled }}
{{- $previewPr := .Values.global.preview.pr | toString }}
{{- $httpRoutes := dict }}
{{- range $name, $config := .Values.httpRoute.httpRoutes }}
  {{- $route := deepCopy $config }}
  {{- $name = include "mozcloud-preview-lib.config.pr-prefix" (dict "pr" $previewPr "value" $name) }}
  {{- $_ := set $httpRoutes $name $route }}
{{- end }}

{{- $httpRouteConfig := dict
    "enabled" .Values.httpRoute.enabled
    "httpRoutes" $httpRoutes
}}

{{- $transformedBackends := dict }}
{{- range $name, $config := .Values.backends }}
  {{- $name = include "mozcloud-preview-lib.config.pr-prefix" (dict "pr" $previewPr "value" $name) }}
  {{- $be := deepCopy $config }}
  {{- $base := default (dict) $be.service.selectorLabels -}}
  {{- $labels := merge (dict) $base -}}
  {{- $_ := set $labels "app.preview/pr" $previewPr -}}
  {{- $_ = set $be.service "selectorLabels" $labels -}}
  {{- $_ = set $be.service "name" $name }}
  {{- $_ = set $transformedBackends $name $be -}}

{{- end }}

{{- $label_params := include "mozcloud-preview.labelParams" . | fromYaml }}

{{- $params := mergeOverwrite $label_params (dict
    "httpRouteConfig" $httpRouteConfig
    "backendConfig" (dict "backends" $transformedBackends)
    "nameOverride" (printf "pr%s-%s" $previewPr (include "mozcloud-preview.name" .))
    "Release" .Release
    "previewPr" $previewPr
    "previewHost" (.Values.global.preview.host | toString)
    "checkPath" (.Values).checkPath
)}}

{{- include "mozcloud-preview-lib.httpRoute" $params }}
{{- include "mozcloud-preview-lib.endpointcheck" $params }}
{{- include "mozcloud-gateway-lib.service" $params }}
{{- include "mozcloud-gateway-lib.healthCheckPolicy" $params }}
{{- end }}
