---
suite: "mozcloud-workload-stateless: Basic configuration"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
chart:
  version: 1.0.0
  appVersion: 1.16.0
values:
  - values/globals.yaml
  - values/basic-configuration.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: Config map is configured correctly
    template: configmap.yaml
    documentSelector:
      path: $[?(@.kind == "ConfigMap")].metadata.name
      value: test-config-map
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-2"
      - isSubset:
          path: data
          content:
            BAZ: qux
            FOO: bar
  - it: External secret is configured correctly
    template: externalsecret.yaml
    documentSelector:
      path: $[?(@.kind == "ExternalSecret")].metadata.name
      value: test-k8s-secret
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-2"
      - contains:
          path: spec.dataFrom
          content:
            extract:
              key: test-gsm-secret
              version: latest
      - equal:
          path: spec.refreshInterval
          value: 5m
      - isSubset:
          path: spec.secretStoreRef
          content:
            kind: SecretStore
            name: secret-store
      - equal:
          path: spec.target.name
          value: test-k8s-secret
  - it: Service account is configured correctly
    template: serviceaccount.yaml
    documentSelector:
      path: $[?(@.kind == "ServiceAccount")].metadata.name
      value: test-service-account
    asserts:
      - equal:
          path: metadata.annotations["argocd.argoproj.io/sync-wave"]
          value: "-2"
      - exists:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: test-sa@moz-fx-mozcloud-workload-nonprod.iam.gserviceaccount.com
  - it: Deployment is configured correctly
    template: deployment.yaml
    documentSelector:
      path: $[?(@.kind == "Deployment")].metadata.name
      value: test-deployment
    asserts:
      - exists:
          path: spec.selector.matchLabels
      - isNotNullOrEmpty:
          path: spec.selector.matchLabels
      - lengthEqual:
          path: spec.template.spec.containers
          count: 1
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: test-config-map
            secretRef:
              name: test-k8s-secret
      - equal:
          path: spec.template.spec.containers[0].image
          value: test-repo/test-image:1.0.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
      - equal:
          path: spec.template.spec.containers[0].name
          value: test-container
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 1
      - isSubset:
          path: spec.template.spec.containers[0].ports[0]
          content:
            containerPort: 8000
            name: app
      - isSubset:
          path: spec.template.spec.containers[0].resources
          content:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: 500m
              memory: 512Mi
      - isSubset:
          path: spec.template.spec.containers[0].securityContext
          content:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
      - isSubset:
          path: spec.template.spec.securityContext
          content:
            runAsGroup: 10001
            runAsNonRoot: true
            runAsUser: 10001
            seccompProfile:
              type: RuntimeDefault
  - it: Pod monitoring is configured correctly
    template: podmonitoring.yaml
    documentSelector:
      path: $[?(@.kind == "PodMonitoring")].metadata.name
      value: test-pod-monitoring
    asserts:
      - contains:
          path: spec.endpoints
          content:
            interval: 30s
            path: /metrics
            port: app
            scheme: http
      - exists:
          path: spec.selector.matchLabels
      - isNotNullOrEmpty:
          path: spec.selector.matchLabels
  - it: HPA is configured correctly
    template: hpa.yaml
    documentSelector:
      path: $[?(@.kind == "HorizontalPodAutoscaler")].metadata.name
      value: test-deployment
    asserts:
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 5
      - lengthEqual:
          path: spec.metrics
          count: 1
      - equal:
          path: spec.metrics[0].resource.name
          value: cpu
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 70
      - isSubset:
          path: spec.scaleTargetRef
          content:
            apiVersion: apps/v1
            kind: Deployment
            name: test-deployment
