---
suite: "mozcloud-workload: Gateway configuration with header matching"
release:
  name: mozcloud-test
  namespace: mozcloud-test-dev
# By overriding the chart version, we are preventing the labels chart from
# updating the mozcloud_chart_version label for every snapshot every time we
# bump chart versions.
chart:
  version: 1.0.0
values:
  - values/globals.yaml
  - values/gateway-configuration-with-header-matching.yaml
templates:
  - gateway.yaml
tests:
  - it: Ensure no failures occur
    asserts:
      - notFailedTemplate: {}
  - it: Configuration matches entire snapshot
    asserts:
      - matchSnapshot: {}
  - it: HTTPS HTTPRoute is configured correctly
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: test-service
    asserts:
      - contains:
          path: spec.parentRefs
          count: 1
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: test-service
            sectionName: https
      - notContains:
          path: spec.parentRefs
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: test-service
            sectionName: http
      - lengthEqual:
          path: spec.rules
          count: 1
      - exists:
          path: spec.rules[0].backendRefs
      - contains:
          path: spec.rules[0].backendRefs
          count: 1
          content:
            group: ""
            kind: Service
            name: test-service
            port: 8080
      - exists:
          path: spec.rules[0].matches
      - exists:
          path: spec.rules[0].matches[0].headers
      - contains:
          path: spec.rules[0].matches[0].headers
          count: 1
          content:
            name: foo
            value: bar
      - notExists:
          path: spec.rules[0].filters[0].requestRedirect
  - it: HTTP-to-HTTPS redirect HTTPRoute is configured correctly
    documentSelector:
      path: $[?(@.kind == "HTTPRoute")].metadata.name
      value: test-service-http-redirect
    asserts:
      - contains:
          path: spec.parentRefs
          count: 1
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: test-service
            sectionName: http
      - notContains:
          path: spec.parentRefs
          content:
            group: gateway.networking.k8s.io
            kind: Gateway
            name: test-service
            sectionName: https
      - lengthEqual:
          path: spec.rules
          count: 1
      - notExists:
          path: spec.rules[0].backendRefs
      - contains:
          path: spec.rules[0].filters
          count: 1
          content:
            requestRedirect:
              scheme: https
              statusCode: 302
            type: RequestRedirect
      - contains:
          path: spec.rules[0].matches
          count: 1
          content:
            path:
              type: PathPrefix
              value: /
